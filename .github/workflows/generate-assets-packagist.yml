name: Build and Publish Plugin

#on:
#push:
#branches:
# - main  # This triggers the workflow on every push to the `main` branch

on:
  push:
    tags:
      - 'v*.*.*' # Trigger for semantic version tags (e.g., v1.0.0)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'  # Adjust to your required Node.js version

      - name: Install dependencies and generate assets
        run: |
          sudo apt-get update
          sudo apt-get install -y make  # Install make utility if it's not available by default
          make init skip-composer  # Run your custom Makefile command

      - name: Print current directory and list assets
        run: |
          echo "Current directory: $(pwd)"
          echo "Contents of the repository:"
          ls -l assets/
          echo "Contents of assets/dist folder:"
          ls -lR assets/dist/

      - name: Upload release to Packagist
        run: |
          curl -X POST -F "package=@release.tar.gz" https://packagist.org/api/package/create
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}

      - name: Upload dist folder as release asset
        uses: softprops/action-gh-release@v1
        with:
          files: 'assets/dist/**'  # Path to your dist folder
        env:
          GITACTIONS_TOKEN: ${{ secrets.GITACTIONS_TOKEN }}
